<div class="background">
	<div class="box">
		<h1 id="sondageName">Nom sondage</h1>
		<p id="sondageDescription">Description...</p>
		<hr>
		<div id="quest_0">
			<label>Email</label>
			<br>
			<input class="form-input" type="email" name="email" id="email">
		</div>
		<div id="questionBox">
		</div>
		<label id="ok" style="color: forestgreen;"></label>
		<br>
		<div class="boxBottom">
			<button onclick="validate()">Envoyer</button>
			<button  onclick="next()">Next</button>
		</div>
	</div>
	

</div>

<style type="text/css">
	.background {
		width: 100%;
		height: 100%;
		color: lightgrey;
	}
	.box {
		color: black;
		background: white;
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		width: 600px;
		min-height: 500px;
		box-shadow: 0 0 1px #ccc;
		border: 1px solid #ccc;
		border-radius: 13px;
		padding: 20px;
		clip: auto;
	}
	.boxBottom {
		background: #C4DBFF;
		position: absolute;
		top: 88%;
		left: 50%;
		transform: translate(-50%, 0%);
		width: 100%;
		min-height: 60px;
		padding: 20px;
		margin: 0px;
		display: flex;
		justify-content: space-between;
		flex-wrap: wrap;
		flex-direction: row;
	}
	.boxBottom button {
		padding: 10px;
		font-size: 16px;
		width: 150px;
		border-radius: 13px;
		border: 0px;
	}
</style>

<script type="text/javascript">
	var datas = {}
	var elements = []
	var currentElement = 0
	var checkSamples = `
	<div>
	  <input class="form-check-input" type="checkbox" id="check#question_id#proposal_id" onclick="valueChange(#question_id,#proposal_id)">
	  <label class="form-check-label">#value</label>
	</div>
	`
	var radioSamples = `
	<div>
	  <input class="form-radio-input" type="radio" name="radio#question_id" id="radio#question_id#proposal_id" onclick="radioValueChange(#question_id,#proposal_id)" option="#proposal_id">
	  <label class="form-radio-label">#value</label>
	</div>
	`
	var textSamples = `
	<div>
	  <input class="form-input" type="text" name="text#question_id" id="text#question_id" onchange="textValueChange(#question_id)" onkeypress="textValueChange(#question_id)">
	</div>
	`
	var numberSamples = `
	<div>
	  <input class="form-input" type="number" name="number#question_id" pattern='[0-9]{10}' id="number#question_id" onchange="numberValueChange(#question_id)" onkeypress="numberValueChange(#question_id)">
	</div>
	`

	// Function for detecting field change
	function valueChange(question_id, proposal_id) {
		if(datas[question_id].indexOf(proposal_id) !== -1) {
			datas[question_id] = datas[question_id].filter(function(e) { return e !== proposal_id })
		} else {
			datas[question_id].push(proposal_id)
		}
	}

	function radioValueChange(question_id, proposal_id) {
		let widget = $("#radio"+question_id+""+proposal_id)
		datas[question_id] = proposal_id
	}

	function textValueChange(question_id) {
		datas[question_id] = $("#text"+question_id).val()
	}

	function numberValueChange(question_id) {
		if(!parseInt($("#number"+question_id).val())) {
			$("#number"+question_id).val
		}
		datas[question_id] = parseInt($("#number"+question_id).val())
	}


	// Function for add new field
	function addCheckBox(e) {
		let cs = ''
		e.response_proposal.forEach(function(v) {
			let sCheck = checkSamples.replaceAll('#question_id',e.id).replaceAll('#proposal_id',v.id).replaceAll("#value",v.libelle)
			cs = cs + '' +sCheck
		})
		$("#questionBox").append('<div style="display: None" id="quest_'+e.id+'"><h4>'+e.libelle+'</h4>'+cs+'</div>')
		elements.push("quest_"+e.id)
	}

	function addRadio(e) {
		let cs = ''
		e.response_proposal.forEach(function(v) {
			let sCheck = radioSamples.replaceAll('#question_id',e.id).replaceAll('#proposal_id',v.id).replaceAll("#value",v.libelle)
			cs = cs + '' +sCheck
		})
		$("#questionBox").append('<div style="display: None" id="quest_'+e.id+'"><h4>'+e.libelle+'</h4>'+cs+'</div>')
		elements.push("quest_"+e.id)
	}

	function addText(e) {
		let sText = textSamples.replaceAll('#question_id',e.id)
		$("#questionBox").append('<div style="display: None" id="quest_'+e.id+'"><h4>'+e.libelle+'</h4>'+sText+'</div>')
		elements.push("quest_"+e.id)
	}
	function addNumber(e) {
		let sNumber = numberSamples.replaceAll('#question_id',e.id)
		$("#questionBox").append('<div style="display: None" id="quest_'+e.id+'"><h4>'+e.libelle+'</h4>'+sNumber+'</div>')
		elements.push("quest_"+e.id)
	}


	// Question navigation

	function next() {
		$("#"+elements[currentElement]).css('display', 'None')
		currentElement = currentElement + 1;
		console.log("#"+elements[currentElement])
		$("#"+elements[currentElement]).css('display', 'block')
	}

	// When user want to submit sondage
	function validate() {
		let data = {
			"person": {"email": $("#email").val()},
			"sondage": sondage,
			"responses": datas
		}
		$.ajax
	    ({
	        type: "POST",
	        url: '/response/submit/',
	        dataType: 'json',
	        contentType: 'application/json',
	        async: false,
	        data: JSON.stringify(data),
	        success: function (rs) {
	        	if("status" in rs) {
	        		$('#questionBox').html('')
	        		$('#ok').text('Formulaire envoy√©')
	        	} else {
	        		console.log(rs)
	        	}
	        	
	        }
	    })
	}

	// Fetch sondage and create html element
	$(document).ready(function(){
		if(sondage != null)
			$.get('/sondage/'+sondage+'/details/', function(result){
				$("#sondageName").text(result.sondage.libelle)
				$("#sondageDescription").text(result.sondage.description)
				elements.push("quest_0")
				result.sondage.questions.forEach(function(e){
					if(e.type_response == 0) {
						datas[e.id] = null
						addRadio(e)
					}
					else if(e.type_response == 1) {
						datas[e.id] = []
						addCheckBox(e)
					}
					else if(e.type_response == 2) {
						datas[e.id] = ""
						addText(e)
					}
					else if(e.type_response == 3) {
						datas[e.id] = null
						addNumber(e)
					}
				})
			})
	})
	
</script>	